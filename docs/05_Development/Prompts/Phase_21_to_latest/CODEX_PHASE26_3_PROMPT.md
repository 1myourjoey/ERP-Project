# Phase 26_3: 조합결성 4대 워크플로우 순차 관리 및 선택적(개별) 생성 체계

> **Priority:** P0

---

## Table of Contents

1. [Part 1 — 워크플로우 단계별 선행 조건 체크 및 진행 방벽 구축 (Sequential Strictness)](#part-1)
2. [Part 2 — '결성예정' 조합 상단 4대 결성 워크플로 개별 생성 CTA 버튼 구축](#part-2)
3. [Part 3 — 동적 템플릿 매핑(Dynamic Mapping) 및 템플릿 교체(Swap) 기능 신설](#part-3)
4. [Part 4 — 결성총회 워크플로의 기존 자본/출자금 연계 로직 보호 및 유기적 이관](#part-4)
5. [Files to create / modify](#files-to-create--modify)
6. [Acceptance Criteria](#acceptance-criteria)
7. [구현 주의사항 (Computer Science Rules)](#구현-주의사항-computer-science-rules)

---

## 현재 상태 및 문제점 분석

결성예정 조합의 워크플로우를 고도화하는 단계입니다. 현업 벤처투자 프로세스를 반영하여 4가지 주요 결성 프로세스를 분리하되, 사용자가 필요시 **건바이건(개별)**으로 파이프라인에 추가할 수 있도록 유연한 관리 체계를 설계합니다.

**주요 목적:**
1. **순차적 무결성(Sequential Integrity):** 업무보드 등에서 1단계를 건너뛰고 3단계 등을 먼저 완료 처리할 수 있는 버그를 수정합니다.
2. **현업 맞춤 개별 버튼 생성:** "결성예정" 상태인 펀드의 상세 내역에 접속했을 때 ① 고유번호증 발급 ② 수탁계약 체결 ③ 결성총회 개최 ④ 벤처투자조합 등록 이라는 **표준 4대 결성 워크플로 버튼 4개**를 각각 배치하여 담당자가 진척 상황에 맞춰 필요할 때 하나씩 추가할 수 있게 합니다.
3. **유연한 템플릿 운용(Dynamic Mapping):** 템플릿 이름이 변경되거나 삭제되었을 때 시스템이 하드코딩된 이름만 찾아 에러를 뿜는 것이 아니라, 사용자가 직접 DB에 있는 템플릿 목록 중 하나를 선택(Mapping)하거나 도중에 타 템플릿으로 교체(Swap)할 수 있는 자유도를 부여합니다.
4. **핵심 자본 로직과의 결합 보존:** 신규 생성되는 3번 결성총회 워크플로의 납입 단계가 완료될 때 펀드의 최초 결성 자본(paid_in)이 연계되는 로직을 안전하게 승계합니다.

---

## Part 1 — 워크플로우 단계별 선행 조건 체크 및 진행 방벽 구축 (Sequential Strictness)

### 1-A. 백엔드 `WorkflowStep` 완료 검증 로직 강제
- **수정 위치:** `backend/routers/workflows.py` 의 `complete_step` API.
- **로직 추가:** 특정 `step` 을 완료(Complete) 상태로 변경하려는 요청이 들어오면, 같은 `workflow_id` 를 가진 단계(Steps) 중 `order`(순서) 필드값이 현재 요청된 단계의 순서보다 낮은(앞선) 단계들의 `status`가 전부 `'completed'` 인지 확인합니다.
- 만약 선행 단계 중 단 하나라도 미완료 상태가 존재한다면 `HTTPException(400, "이전 단계를 먼저 완료해야 합니다.")` 를 뱉어내고 롤백합니다.

### 1-B. 프론트엔드 비활성화 및 시각적 피드백
- **수정 위치:** 대시보드 파이프라인 워크플로 팝업 모달, 업무 상세 등 단계 체크리스트 UI
- 현재 순서가 아닌 뒷단계를 클릭하려고 할 경우 UI 적으로 해당 체크박스(또는 Action Button)를 `disabled` 상태로 고정시키고, 커서를 올렸을 때 툴팁("이전 단계를 먼저 완료해주세요")을 노출시켜 UX 혼선을 예방합니다.

---

## Part 2 — '결성예정' 조합 상단 4대 결성 워크플로 개별 생성 CTA 버튼 구축

### 2-A. 프론트엔드 "조합 결성 개별 프로세스 추가" 버튼 4종 UI 기획
- **대상 페이지:** `FundDetailPage.tsx` 의 상단 Header 영역 혹은 '결성 진행 컨트롤 패널' 컴포넌트 신설
- **노출 조건:** 해당 펀드의 `status` 가 **'결성예정'** 일 때 디스플레이 됨.
- **버튼 구성:** 상황에 맞추어 개별적으로 추가할 수 있는 4개의 버튼 그룹(Button Group)으로 구성합니다:
  1. `[+ 고유번호증 발급 워크플로 추가]`
  2. `[+ 수탁계약 체결 워크플로 추가]`
  3. `[+ 결성총회 개최 워크플로 추가]` 
  4. `[+ 투자조합 등록 워크플로 추가]`
- **상태 연동 (Disabled 조건):** 각 워크플로별로 이미 백엔드 DB에 동일 펀드 타겟으로 생성되어 파이프라인에 존재한다면, 파생 버튼은 비활성화(Disabled) 되거나 "추가 완료됨 ✅" 형태로 변하여 중복 생성을 막아야 합니다.
- **클릭 액션 (개선):** 단순 확인 후 즉시 쏘는 것이 아니라, **[Part 3]** 의 매핑 모달을 띄워 유저가 템플릿을 최종 확정하게 합니다.

---

## Part 3 — 동적 템플릿 매핑(Dynamic Mapping) 및 템플릿 교체(Swap) 기능 신설 (사용자 커스텀 강화)

### 3-A. 생성 시점의 템플릿 매핑 (Fallback + Customization)
- `[+ 수탁계약 체결 워크플로 추가]` 버튼을 클릭했을 때 발생하는 일의 순서:
  1. 시스템은 기본적으로 '수탁계약' 이라는 키워드를 가진 마스터 템플릿을 DB에서 찾습니다.
  2. **모달 팝업 노출:** 만약 찾았다면 해당 템플릿을 Default Value 로 보여주고, 못 찾았다면 빈 칸(Dropdown Select)으로 둡니다.
  3. 모달 내 콤보박스(`Select`)에는 DB에 존재하는 모든 `WorkflowTemplates` 목록이 뿌려져 있습니다. 사용자는 언제든 시스템이 추천한 기본 템플릿을 무시하고, 자사에서 새로 만든 **"2026년형 V:ON 커스텀 수탁계약 템플릿"** 을 드롭다운에서 선택하여 "추가하기"를 누를 수 있습니다.
  4. 이로써 시스템에 특정 이름의 템플릿이 반드시 존재해야만 돌아가던 '하드코딩(Hardcoding)' 의존성이 완벽히 제거됩니다.

### 3-B. 기존 워크플로 인스턴스의 '템플릿 교체(Template Swap)' 기능
- 파이프라인이나 업무 보드에 이미 올라가 있는 '진행 전(대기)' 상태의 워크플로에 대하여, **[🔄 템플릿 교체]** 아이콘 버튼을 노출시킵니다.
- 클릭 시 다시 전체 템플릿 리스트 Dropdown이 열리며, 타 템플릿 선택 시 해당 워크플로 인스턴스에 종속되어 있던 구형 Steps 와 Tasks 들이 전부 지워지고(Cascade Delete 혹은 Soft-delete) **신규 템플릿에 맞게 스키마가 통째로 물갈이되어 재생성**됩니다.
  - *단, 이미 내부 단계가 하나라도 '진행중' 또는 '완료' 로 넘어간 워크플로에 대해서는 데이터 붕괴를 막기 위해 교체(Swap) 버튼을 Disabled 처리하거나 차단해야 합니다.*

---

## Part 4 — 결성총회 워크플로의 기존 자본/출자금 연계 로직 보호 및 유기적 이관

### 4-A. Keyword 감지 및 동기화 방어 코드 이식 (핵심 C.S. 룰)
- 현재 프로젝트 코드베이스(`workflows.py` 또는 `capital_calls.py` 근방)에 흩어져 있는 **"특정 워크플로 단계 완료 시 출자금, 결성금액을 실시간으로 싱크(sync) 맞추고 자본(Paid-in) 값을 건드리는 하드코딩 트리거(Trigger)"** 가 존재합니다.
- [Part 3] 에서 사용자가 어떤 커스텀 템플릿을 골라 "결성총회 개최" 역할을 부여하더라도, 그 템플릿 내에 **이벤트 리스너 문자열 검사조건(ex: `if "납입 확인" in step.name:`)과 매칭되는 텍스트를 가진 Step**이 반드시 포함되어야 자본 연계가 발동합니다.
- 백엔드 교체 로직은 그대로 두되, 사용자 안내문구(팝업 모달 하단)에 *"결성총회 관련 워크플로를 다른 템플릿으로 교체 시, 내부 단계에 '출자금 납입(예시)' 이라는 명칭이 반드시 포함되어 있어야 결성금액이 조합 정보에 정상적으로 반영됩니다."* 라는 경고 문구를 명시해야 합니다.

---

## Files to create / modify

| # | Type | File | Changes |
|---|------|------|---------|
| 1 | **[MODIFY]** | `backend/routers/workflows.py` | 워크플로 Step `complete` 시 단계별 역전 방지 체크(400 에러) 구현 및 `PUT /api/workflows/{id}/swap-template` 개발 |
| 2 | **[NEW]** | `backend/routers/funds.py` (or new endpoint) | `POST /api/funds/{fund_id}/add-formation-workflow` 템플릿 ID를 명시적으로 파라미터로 받는 동적 생성기 구축 |
| 3 | **[MODIFY]** | `frontend/src/pages/FundDetailPage.tsx` | 결성예정 상태 하단 개별 4개 CTA 버튼, 클릭 시 Dynamic mapping Select Modal 렌더링 |
| 4 | **[MODIFY]** | `frontend/src/components/...` (Workflow 렌더/모달) | 상태가 '대기' 인 워크플로에 한하여 템플릿 교체(Swap) 콤보박스 활성화 기능 추가 |
| 5 | **[MODIFY]** | (코드베이스 內 자본 연계 핵심 스크립트) | 3번째 결성총회 자본 동기화 Event Trigger 유지 및 사용자 매뉴얼 연동 방어 |

*(코덱스는 위 가이드뿐만 아니라 스스로 코드베이스와 기존 파이프라인의 이벤트를 전부 `grep_search`하여 정확한 함수 및 컴포넌트를 특정, 병합해야 합니다.)*

---

## Acceptance Criteria

- [ ] AC-01: 시스템 내 파이프라인 진행 시, 1단계에 완료 표시(Check) 처리가 되어있지 않으면 절대로 하위 단계(2번, 3번) 체크박스를 조작할 수 없으며 클릭 시 시각적 블락(Tooltip)이 가동된다. UI 조작 우회로 API 요청을 보내도 백엔드에서 400 에러로 거부(Reject)한다.
- [ ] AC-02: '결성예정' 상태인 펀드의 상세 페이지(`FundDetailPage`) 상단 배열에 **"고유번호증, 수탁계약, 결성총회, 조합등록"** 4개의 + 워크플로 추가 버튼 패널이 각각 선명하게 표시된다.
- [ ] AC-03: 생성 버튼을 누르면 즉시 추가되는 것이 아니라, 전체 `WorkflowTemplates` 목록을 불러오는 **템플릿 선택 모달(Select Modal)**이 열린다. 시스템이 추천한 기본값이 세팅되어 있되 강제가 아니며, 유저는 드롭다운에서 아무 커스텀 템플릿이나 골라 생성(매핑)을 완료할 수 있다.
- [ ] AC-04: 이미 등록된 워크플로라도 아직 1단계도 수행하지 않은 완전 대기 상태라면, 워크플로 조작 패널에 **[템플릿 변경]** 기능이 활성화되어 다른 템플릿 구조로 즉각 초기화(통째 교체) 시킬 수 있다. (진행 상태가 1이라도 탔다면 버튼은 숨겨짐)
- [ ] AC-05: 버튼을 눌러 추가된 3번째 "결성총회 개최" 계열의 워크플로 인스턴스를 열고 들어가 내부 출자/납입 관련 단계를 체크(완료) 처리 시, **ERP 시스템 內 기존 결성금액 캐시 반영 트리거**가 여전히 정상 작동하여야 한다. 모달 하단엔 지정된 키워드 사용을 당부하는 가이드 문구가 존재한다.

---

## 구현 주의사항 (Computer Science Rules)

1. **Destructive Swap Handling (템플릿 교체의 원자성):** 템플릿을 중간에 바꾸는(Swap) 백엔드 API 작동 원리는 기본적으로 기존 하위 `Steps` 와 매핑된 `Tasks` 데이터의 **Hard-Delete 후 재생성**을 의미한다. 만일의 버그나 데이터 고립(Orphan Record)을 방지하기 위해 반드시 `session.execute(delete(WorkflowStep).where(...))` 구문을 트랜잭션 단위로 강하게 묶어 한 치의 잔여물도 남기지 말 것.
2. **Hardcoded String Matching Danger:** 현재 결성금액을 합산해주는 백엔드 트리거는 `step.name`을 찾아 이벤트 콜백을 돌리는 하드코딩 구조다. 개발자(코덱스)는 `grep_search`로 "납입" , "출자" 등의 Hook String을 추적하여 파악하고, 프론트 단 모달 안내문에 *"결성총회 관련 템플릿을 교체 시, 스텝 이름에 반드시 [찾아낸 핵심 키워드] 라는 단어가 포함된 템플릿을 선택하셔야 자본 동기화가 정상 작동합니다"* 라는 안내문을 UI상에 삽입해야 사용자의 실수를 막을 수 있다.
3. **Pessimistic vs Optimistic UI 업데이트:** 파이프라인 모달창의 단계별 완료 체크 로직은 선행 조건 에러(400)가 발생할 소지가 많으므로 Pessimistic Update(API 200 응답 이후 프론트 체크 표시 적용)가 절대 권장되며, 강제 원복(UI Flicker)으로 인한 불쾌감을 차단하라.
