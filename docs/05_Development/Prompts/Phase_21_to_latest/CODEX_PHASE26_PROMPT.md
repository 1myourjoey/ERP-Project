# Phase 26: 종합 시스템 감사, 데이터 정합성 검증 및 LP 기능 연계 고도화

> **Priority:** P0

---

## Table of Contents

1. [Part 1 — 시스템 전반 데이터 정합성(Data Integrity) 검증 및 강제](#part-1)
2. [Part 2 — LP(출자자) 연계 기능 버그 수정 및 유기적 통합](#part-2)
3. [Part 3 — 출자이력 및 납입 현황 UI 완벽 동기화](#part-3)
4. [Part 4 — C.S. 레벨의 엣지 케이스 점검 및 데이터 보정](#part-4)
5. [Files to create / modify](#files-to-create--modify)
6. [Acceptance Criteria](#acceptance-criteria)
7. [구현 주의사항](#구현-주의사항)

---

## 현재 상태 및 문제점 분석

현재 Phase 25까지 구현을 마쳤으나 기능 간의 **논리적 연계성**과 **데이터 무결성(Data Integrity)** 측면에서 심각한 결함이 발견되었습니다. 특히 LP(유한책임조합원) 관련 기능들의 결합도가 낮고 값의 정합성이 맞지 않습니다.

**주요 문제점:**
1. **납입액 역전 현상:** 개별 LP 혹은 조합 전체의 납입액(Paid-in)이 약정총액(Commitment Amount)을 초과하는 것을 시스템이 허용하고 있습니다. 이는 펀드 재무운용에 있어 치명적 오류입니다.
2. **LP 출자이력 데이터 붕괴:** LP의 출자요청별 납입 현황 데이터가 제대로 누적, 기록되지 않고 UI 목록과 실제 값이 일치하지 않게 렌더링되고 있습니다.
3. **UI/캐시 비동기화:** 특정 LP의 납입을 처리하거나 데이터를 변경했을 때, 하단 LP 목록의 약정액/납입액 수치가 즉각적이고 유기적으로 변동되지 않으며, 서로 간의 연결(Linkage)이 단절되어 있습니다.

이 단계는 새로운 컴포넌트 추가보다는 **기존 시스템의 논리적 모순을 파괴하고 완벽히 연결하는 "통합 감사(System Audit) 및 리팩토링"**에 집중해야 합니다.

---

## Part 1 — 시스템 전반 데이터 정합성(Data Integrity) 검증 및 강제

### 1-A. 백엔드 제약조건 및 검증 로직 추가 (Backend Validation)
- `CapitalCall`, `CapitalCallItem`, `LP` 모델 데이터를 업데이트, 생성, 동기화하는 모든 API endpoint(`routers/workflows.py`, `routers/funds.py` 등)에 검증 로직을 철저하게 하드코딩 수준으로 삽입합니다.
- **제약 조건:** `(기존 누적 납입액 + 이번 출자 납입액) <= 약정총액(commitment_amount)`
- 만약 초과할 경우 명확한 `400 Bad Request` 에러(예: "납입 총액이 약정 총액을 초과할 수 없습니다.")를 반환하여 데이터베이스 오염을 원천 차단해야 합니다.

### 1-B. 프론트엔드 입력 방지 및 UX 처리
- 프론트엔드 출자금 납입 위저드 및 직접 입력 폼에서, 남은 미납액(`약정총액 - 납입총액`)을 실시간 계산하여, 사용자가 입력할 수 있는 최대 금액(max value)으로 제한합니다.
- 초과 금액 입력 시 폼의 화면 단에서 Submit 버튼을 비활성화하고 붉은색 경고 메시지를 즉시 렌더링합니다.

---

## Part 2 — LP(출자자) 연계 기능 버그 수정 및 유기적 통합

### 2-A. LP 모델과 연관 데이터 참조 구조 딥 다이브
- 데이터베이스 쿼리 시, 개별 `CapitalCallItem`에서 발생한 `paid` 상태 변화 또는 금액(`amount`) 변화가 부모(Parent)인 `LP.paid_in` 파라미터에 빠짐없이 Aggregate(합산)되어 업데이트되도록 서비스 레이어의 트랜잭션을 단일화해야 합니다.
- 납입 내역이 추가/삭제/수정될 때마다 LP 테이블의 누적액 필드가 자동으로 동기화되도록 DB 레벨이나 ORM Hook 메서드를 적극 활용하여 방어 로직을 짭니다.

### 2-B. 출자이력 데이터 로직 정상화
- 현재 망가진 LP 납입 현황 데이터를 복원하기 위해 출자요청(Capital Call)과 납입 결과가 쌍(Pair)으로 정확히 일치하는지 백엔드 로직을 전수 검사합니다.
- 단일 진실 공급원(Single Source of Truth) 원칙에 따라 중복 관리되는 상태(State) 값 필드가 있다면 통합하고, 어긋나는 로직을 제거합니다.

---

## Part 3 — 출자이력 및 납입 현황 UI 완벽 동기화

### 3-A. React Query Invalidation 정책 전면 재설계 (유기적 연결)
- 하단 LP 목록, 조합 상세 개요, 대시보드의 수치가 따로 노는 현상은 Query Key 무효화가 누락되거나 시점이 어긋났기 때문입니다.
- 납입 상태 수정 API, 워크플로 완료 API 등이 성공(`onSuccess`)하는 즉시 다음 쿼리 키들을 동시에, 그리고 일괄적으로 `invalidateQueries` 처리하도록 `api.ts` 또는 훅(Hooks) 단을 보완합니다:
  - `['fundDetails', fundId]` (조합 상단 요약 데이터)
  - `['fundLPs', fundId]` (하단 LP 목록 배열)
  - `['capitalCalls']`, `['capitalCallItems']`
  - `['fundPerformance']`
- **목표:** 워크플로에서 "납입 완료" 처리 시, 해당 모달창이 닫힘과 동시에 뒷배경의 전체 펀드 납입률, 개별 LP의 약정액 대비 납입그래프 수치가 **1초 이내에 새로고침 없이 유동적으로 변동**되어야 합니다.

---

## Part 4 — C.S. 레벨의 엣지 케이스 점검 및 데이터 보정

### 4-A. 데이터 무결성 보정 스크립트 작성 (Data Migration)
- 기존 DB에 이미 들어가 있는 오염된 데이터(예: 납입액 > 약정액 인 LP, 합산이 안맞는 LP 등)를 찾아내고, `CapitalCallItem` 기준으로 `LP.paid_in`을 재계산하여 올바르게 맞추는 1회성 마이그레이션 혹은 보정 엔드포인트(혹은 스크립트) 코드를 작성합니다. `backend/scripts/audit_fix_lps.py` 형태.

### 4-B. 예외 상황 방어 (Edge Cases Handling)
- **동시성 문제 (Concurrency):** 동시다발적으로 납입 API가 여러 번 호출되더라도 약정액을 초과하지 않도록 DB 트랜잭션과 Lock 개념을 점검하여 안전하게 자본이 업데이트되도록 구조화합니다.
- **포맷 및 타입 안정성:** 금액 필드(Amount)에 음수(-)나 0이 입력되었을 때 시스템이 붕괴되지 않도록 Pydantic 밸리데이터를 재검증합니다.

---

## Files to create / modify

| # | Type | File | Changes |
|---|------|------|---------|
| 1 | **[MODIFY]** | `backend/routers/...` | Capital Call 및 워크플로 단계 완료 시 약정총액 초과방지 Validation 강제 삽입 |
| 2 | **[MODIFY]** | `backend/services/...` | 출자 명세와 LP 간의 누적 합산 로직 트랜잭션 전면 통합 및 디버깅 |
| 3 | **[MODIFY]** | `frontend/src/components/...` | 잔여 약정액 기반 input max 제한 로직 설계 및 초과 경고 UI 추가 |
| 4 | **[MODIFY]** | `frontend/src/pages/FundDetailPage.tsx` 등 | Query Key Invalidation 누락 컴포넌트 전부 추가 (실시간 유기적 연결) |
| 5 | **[NEW]**| `backend/scripts/audit_fix_lps.py` | (선택적) 기존 어긋난 출자 데이터 재정렬 및 일관화 적용 스크립트 |

*(코덱스는 위 가이드뿐만 아니라 스스로 코드베이스를 `grep_search`하여 문제가 되는 정확한 경로와 파일들을 특정하고 작업해야 합니다.)*

---

## Acceptance Criteria

- [ ] AC-01: 시스템의 어떠한 경로(API 임의 호출, Postman 등)로도 LP 단위 및 펀드 단위의 누적 납입총액이 약정총액을 초과하여 DB에 저장될 수 없다. (초과 시 즉각적인 400 에러 반환)
- [ ] AC-02: 프론트엔드 출자 관련 폼에서 '미납액'을 초과하는 금액을 사용자가 입력하려 하면 폼 자체가 비활성화되고 시각적 에러메시지가 노출된다.
- [ ] AC-03: 특정 LP의 납입/출자 상태를 변경하면, 그 즉시(새로고침 없이) 해당 페이지의 컴포넌트인 '전체 누적 납입총액', '해당 LP 리스트의 상태값', '미납액 그래프'가 유기적으로 동기화 변경된다.
- [ ] AC-04: 백엔드 DB 내의 `LP` 테이블의 `paid_in` 누적 필드는 `CapitalCallItem`들의 합산분과 프로그래밍적으로 100% 동일하게 일치하며 동기화가 보장된다.
- [ ] AC-05: 기존에 버그로 인해 꼬여있던 데이터들도 오류 없이 렌더링되거나 보정 스크립트를 통해 정상화될 수 있어야 한다.

---

## 구현 주의사항

1. **"동작하는 척" 하는 눈속임 로직 작성을 무조건 금지합니다.** 
   프론트엔드에서 React State나 임시 변수로 화면의 값만 바꿔치기해서 사용자 눈만 속이는 방식은 금지됩니다. 반드시 백엔드 DB 트랜잭션을 올바르게 타서 변경된 데이터를 서버사이드 캐시에서 `invalidate`하고 다시 `fetch`해와서 화면이 렌더링되어야 합니다.
2. **원자성 보장 단위 트랜잭션 묶기:** 원장(Commitment) 현황과 납입(Paid) 현황, 그리고 워크플로(Workflow) 상태가 변경되는 복합 로직에서는 `db.commit()`이 중간에 실패하면 전체가 롤백(`db.rollback()`)되도록 세션 관리를 철저히 해야 합니다.
3. 이 프롬프트는 단순한 피처(Feature) 추가가 아닌 **Core Engine 디버깅 및 무결성 사수** 작업입니다. 수정 전 반드시 영향을 받는 모델과 연관 함수들의 컴포넌트 구조를 철저히 검색하고 파악한 뒤 코딩에 진입하십시오.
